# Feature 0026: Restructurare Completă - Evidențiere Avantaje Nihao pentru Vânzători și Cumpărători CEA

**Status:** ✅ VALIDATED & RESOLVED  
**Validation:** See `0026_VALIDATION.md`  
**Resolution Plan:** See `0026_RESOLUTION_PLAN.md`

## Resolved Issues

All validation issues have been addressed. Key decisions:

- **Terminology**: CER → CEA migration throughout codebase (Option A)
- **Market Analysis Endpoint**: Create new `/api/market/analysis` endpoint (Option A)
- **API Naming**: Use `/api/calculator/...` for consistency
- **Route Protection**: Specified for each new route (see UI Changes section)
- **Market Data**: CEA prices from enhanced scraper, swap ratios from `SwapCalculator` service, compliance periods from `ComplianceDetector` utility
- **Research Scenarios**: Verified in `docs/research/CEA-seller-reason.md` and `docs/research/swap-reason.md`

## Overview

Această modificare majoră restructurează complet aplicația pentru a evidenția clar avantajele utilizării platformei Nihao atât pentru vânzătorii de CEA (companii chineze), cât și pentru cumpărătorii de CEA care doresc să facă swap pentru EUA (companii europene). Platforma va deveni un instrument de demonstrare a valorii, transformând interfața actuală într-o experiență care educă utilizatorii despre beneficiile concrete ale intermediării Nihao în contextul piețelor fragmentate de carbon.

## Objectives

- [ ] **Evidențiere Avantaje Vânzători CEA**: Demonstrare clară a beneficiilor pentru companiile chineze care vând CEA prin Nihao (lichiditate instantanee, preț mai bun, confidențialitate, buyer of last resort)
- [ ] **Evidențiere Avantaje Cumpărători CEA**: Demonstrare clară a beneficiilor pentru companiile europene care cumpără CEA pentru swap cu EUA (acces fără WFOE, optimizare CBAM, evitare capital controls)
- [ ] **Calculator Comparativ**: Instrument interactiv care compară scenarii alternative (vânzare directă vs. Nihao, swap direct vs. Nihao) cu calcule concrete de economii
- [ ] **Storytelling Contextual**: Integrare scenarii reale din cercetare în interfață pentru a demonstra valoarea concretă
- [ ] **Dashboard Reimaginat**: Transformare dashboard pentru a evidenția oportunități de arbitraj și economii potențiale
- [ ] **Market Analysis Avansată**: Analiză comparativă EUA vs CEA cu evidențierea oportunităților de swap

## Technical Approach

### Architecture Changes

- **Nou Context de Valoare**: Context React pentru gestionarea calculelor de valoare și scenarii comparate
- **Service de Calcul**: Service dedicat pentru calcule de economii, swap ratios, și comparații de scenarii
- **Componente Educaționale**: Noi componente pentru prezentarea avantajelor cu date concrete din cercetare
- **Calculator Engine**: Motor de calcul pentru scenarii multiple cu persistare rezultate

### Data Model Changes

- **Tabel `value_scenarios`**: Stocare scenarii calculate de utilizatori pentru comparație ulterioară
  - `id`: VARCHAR(36) PRIMARY KEY (UUID string)
  - `user_id`: VARCHAR(36) NOT NULL (Foreign key către users.id)
  - `scenario_type`: VARCHAR(20) NOT NULL (ENUM: 'seller_cea', 'buyer_swap')
  - `input_data`: TEXT NOT NULL (JSON serialized cu datele de intrare: volum, preț, timing, etc.)
  - `nihao_benefits`: TEXT NOT NULL (JSON serialized cu beneficiile calculate)
  - `alternative_costs`: TEXT NOT NULL (JSON serialized cu costurile scenariului alternativ)
  - `savings`: REAL NOT NULL (diferența calculată în EUR)
  - `created_at`: DATETIME NOT NULL (timestamp creare)
  - **Indexuri:** `idx_value_scenarios_user_id`, `idx_value_scenarios_created_at`

- **Tabel `market_opportunities`**: Cache pentru oportunități de arbitraj detectate
  - `id`: VARCHAR(36) PRIMARY KEY (UUID string)
  - `opportunity_type`: VARCHAR(30) NOT NULL (ENUM: 'arbitrage', 'swap_optimization', 'liquidity_crisis')
  - `market_data`: TEXT NOT NULL (JSON serialized cu datele pieței relevante)
  - `potential_savings`: REAL NOT NULL (economii potențiale în EUR)
  - `expires_at`: DATETIME (nullable, pentru expirare cache)
  - `created_at`: DATETIME NOT NULL (timestamp creare)
  - **Indexuri:** `idx_market_opportunities_type`, `idx_market_opportunities_expires_at`
  
**Note:** SQLite nu suportă ENUM nativ, deci folosim VARCHAR cu validare la nivel de aplicație sau SQLAlchemy Enum.

### API Changes

#### New Endpoints

- **POST `/api/calculator/seller-scenario`**: Calculează beneficiile pentru vânzător CEA
  - Body: `{ volume: number, currentPrice: number, urgency: 'normal' | 'urgent' | 'panic', confidentiality: boolean, fxPreference?: 'RMB' | 'EUR' | 'USD' }`
  - Response: `{ nihaoOffer: { price: number, executionTime: string, totalValue: number }, shanghaiAlternative: { price: number, executionTime: string, totalValue: number, marketImpact: number }, benefits: { liquidity: string, pricePremium: number, timeSavings: string, confidentiality: boolean, fxFlexibility: boolean }, totalSavings: number, savingsPercentage: number }`

- **POST `/api/calculator/buyer-swap-scenario`**: Calculează beneficiile pentru cumpărător CEA (swap)
  - Body: `{ euaVolume: number, euaPrice: number, swapRatio: number, useCase: 'compliance' | 'cbam' | 'investment' | 'divestment', hasChinaOperations: boolean }`
  - Response: `{ directSwapCosts: { wfoeSetup: number, timeToMarket: string, capitalControlsRisk: boolean, fxExposure: number }, nihaoSwap: { fee: number, executionTime: string, noWfoeNeeded: boolean, noCapitalControls: boolean }, benefits: { wfoeSavings: number, timeSavings: string, riskReduction: string, cbamOptimization?: number }, totalSavings: number, savingsPercentage: number }`

- **GET `/api/market/opportunities`**: Returnează oportunități detectate de arbitraj
  - Query params: `type?`, `minSavings?`
  - Response: `{ opportunities: MarketOpportunity[] }`

- **POST `/api/calculator/scenarios`**: Salvează scenariu calculat pentru utilizator
  - Body: `{ scenarioType: string, inputData: object, results: object }`
  - Response: `{ scenarioId: string, savedAt: string }`

- **GET `/api/calculator/scenarios`**: Listează scenarii salvate ale utilizatorului
  - Response: `{ scenarios: ValueScenario[] }`

- **GET `/api/market/analysis`**: NOU - Endpoint dedicat pentru analiză de piață
  - Response: `{ currentPrices: { eua: {...}, cea: {...} }, spread: { absolute: number, percentage: number, arbitrageOpportunity: boolean }, arbitrageOpportunities: ArbitrageOpportunity[], swapRecommendations: SwapRecommendation[], historicalTrends: {...} }`
  - Note: Acest endpoint va fi creat nou (nu extins) și va agrega date din `/api/eua/price`, `/api/cea/price`, și serviciile de analiză

### UI Changes

#### New Pages

- **`/value-calculator`**: Pagină dedicată calculatorului de valoare cu două moduri (Vânzător CEA / Cumpărător Swap)
  - **Route Protection**: `ProtectedRoute` (requires auth + KYC approval)
  - **Reason**: Core feature, should be available to approved users

- **`/benefits`**: Pagină educațională care explică avantajele Nihao cu scenarii reale din cercetare
  - **Route Protection**: `OnboardingRoute` (requires auth only, not KYC)
  - **Reason**: Educational/marketing content, can be shown during onboarding
  - **Scenarios Source**: `docs/research/CEA-seller-reason.md` (8 scenarios) și `docs/research/swap-reason.md` (6 scenarios)

- **`/market-opportunities`**: Pagină care afișează oportunități detectate de arbitraj și swap
  - **Route Protection**: `ProtectedRoute` (requires auth + KYC approval)
  - **Reason**: Actionable opportunities, should be for approved users only

#### Modified Pages

- **Dashboard**: Restructurat pentru a evidenția oportunități de economii și valoare
  - Carduri noi: "Potential Savings Today", "Active Opportunities", "Recommended Actions"
  - Widget comparativ preț EUA vs CEA cu evidențiere gap de arbitraj
  - Quick calculator inline pentru estimări rapide

- **Market**: Adăugare secțiune "Swap Opportunities" cu calculator integrat
- **Market Analysis**: Extins cu analiză comparativă detaliată și recomandări swap

#### New Components

- **`ValueCalculator`**: Calculator principal cu două moduri (seller/buyer)
- **`SellerBenefitsCard`**: Card care prezintă avantajele pentru vânzători cu date concrete
- **`BuyerBenefitsCard`**: Card care prezintă avantajele pentru cumpărători cu date concrete
- **`ScenarioComparison`**: Componentă pentru compararea scenariilor side-by-side
- **`SavingsVisualization`**: Grafic vizual pentru economii calculate
- **`ArbitrageOpportunityCard`**: Card pentru oportunități de arbitraj detectate
- **`SwapRecommendation`**: Componentă pentru recomandări de swap personalizate

## Implementation Steps

### Phase 1: Foundation - Data Models & API Backend

1. **Migrare terminologie CER → CEA** ⚠️ **PREREQUISITE FOR ALL OTHER STEPS**
   - **Backend Changes:**
     - Rename endpoint `/api/cer/price` → `/api/cea/price` în `backend/app.py`
     - Rename endpoint `/api/cer/history` → `/api/cea/history` în `backend/app.py`
     - Rename funcție `scrape_cer_price()` → `scrape_cea_price()` în `backend/scraper.py`
     - Update `historical_data_collector.py`: toate referințele CER → CEA
     - Update comentarii și docstrings: CER (Certified Emission Reduction) → CEA (China ETS Allowances)
   - **Frontend Changes:**
     - Update `src/services/cerPriceService.ts` → `ceaPriceService.ts` (rename file)
     - Update `src/context/StatsContext.tsx`: `averagePriceCER` → `averagePriceCEA`, `volumeCER` → `volumeCEA`
     - Update `src/pages/MarketAnalysis.tsx`: toate referințele CER → CEA
     - Update `src/pages/Market.tsx`: filter `offer.type === 'CEA'` (was 'CER')
     - Update `src/pages/Dashboard.tsx`: toate referințele CER → CEA
     - Update `src/types/*.ts`: toate tipurile și interfețele CER → CEA
   - **Documentation:**
     - Update `backend/README.md`: endpoint documentation
     - Update comentarii în cod
   - **Note:** Această migrare trebuie completată înainte de implementarea noilor features care depind de terminologia CEA. Testare completă necesară pentru a asigura că toate referințele sunt actualizate.

2. **Creare migrație baze de date**
   - **Tabel `value_scenarios`:**
     - `id`: VARCHAR(36) PRIMARY KEY (UUID)
     - `user_id`: VARCHAR(36) NOT NULL (FK către users.id)
     - `scenario_type`: VARCHAR(20) NOT NULL (ENUM: 'seller_cea', 'buyer_swap')
     - `input_data`: TEXT NOT NULL (JSON serialized)
     - `nihao_benefits`: TEXT NOT NULL (JSON serialized)
     - `alternative_costs`: TEXT NOT NULL (JSON serialized)
     - `savings`: REAL NOT NULL (diferența calculată)
     - `created_at`: DATETIME NOT NULL
     - Indexuri: `idx_value_scenarios_user_id`, `idx_value_scenarios_created_at`
   - **Tabel `market_opportunities`:**
     - `id`: VARCHAR(36) PRIMARY KEY (UUID)
     - `opportunity_type`: VARCHAR(30) NOT NULL (ENUM: 'arbitrage', 'swap_optimization', 'liquidity_crisis')
     - `market_data`: TEXT NOT NULL (JSON serialized)
     - `potential_savings`: REAL NOT NULL
     - `expires_at`: DATETIME (nullable, pentru cache expiration)
     - `created_at`: DATETIME NOT NULL
     - Indexuri: `idx_market_opportunities_type`, `idx_market_opportunities_expires_at`
   - **Script:** `backend/scripts/migrate_0026_value_scenarios.py`
   - **Pattern:** Urmează modelul din `migrate_access_requests_0022.py`
     - Dry-run mode pentru testare sigură (`--dry-run`)
     - Verificare starea curentă înainte de migrație (check if tables exist)
     - Rollback automat la erori (transaction-based)
     - Verificare post-migrație
   - **Usage:**
     ```bash
     cd backend
     python scripts/migrate_0026_value_scenarios.py --dry-run  # Test first
     python scripts/migrate_0026_value_scenarios.py  # Execute
     ```
   - **Rollback:** Drop tables dacă migrația eșuează (`DROP TABLE IF EXISTS value_scenarios; DROP TABLE IF EXISTS market_opportunities;`)
   - **Backup:** Creare backup înainte de migrație (`cp kyc_database_dev.db kyc_database_dev.db.backup`)
   - **Note:** Tabelele sunt noi, nu există date existente de migrat (simplifică migrația)

3. **Implementare backend services**
   - `ValueCalculatorService`: Logică de calcul pentru scenarii vânzător
   - `SwapCalculatorService`: Logică de calcul pentru scenarii swap și swap ratios
     - Calculează ratio EUA:CEA bazat pe prețuri și condiții de piață
     - Ajustări pentru liquidity premium, compliance timing, volume discounts
   - `MarketOpportunityDetector`: Detector automat de oportunități bazat pe date pieței
   - `ComplianceDetector` (utility): Detectează perioade de compliance (Oct-Dec)
     - Metode: `is_compliance_period()`, `days_until_deadline()`, `get_market_condition()`

4. **Implementare API endpoints**
   - POST `/api/calculator/seller-scenario` cu validare input și calcule
   - POST `/api/calculator/buyer-swap-scenario` cu validare și calcule
   - GET `/api/market/opportunities` cu caching inteligent
   - POST/GET `/api/calculator/scenarios` pentru persistare scenarii
   - GET `/api/market/analysis` - NOU endpoint pentru analiză agregată
     - Agregă date din `/api/eua/price`, `/api/cea/price`, și servicii de analiză
     - Returnează spread, oportunități arbitraj, recomandări swap
     - Blueprint: `backend/api/market_analysis.py`
     - **IMPORTANT**: Acest endpoint trebuie creat înainte de modificarea `MarketAnalysis.tsx` în Phase 3 Step 10

5. **Testare backend**
   - Unit tests pentru calculatoare cu scenarii din cercetare
   - Integration tests pentru API endpoints
   - Validare calcule cu date reale din documentație
   - Testare endpoint `/api/market/analysis` pentru a asigura disponibilitatea înainte de Phase 3

### Phase 2: Core Components - Calculator & Benefits

6. **Creare ValueCalculator component**
   - Design cu două tabs (Vânzător CEA / Cumpărător Swap)
   - Formulare de input cu validare
   - Integrare cu API endpoints
   - Afișare rezultate cu vizualizări

7. **Creare componente Benefits**
   - `SellerBenefitsCard` cu scenarii din cercetare (liquidity crisis, banking panic, etc.)
   - `BuyerBenefitsCard` cu scenarii din cercetare (CBAM optimization, compliance, etc.)
   - Storytelling cu exemple concrete numerice

8. **Creare ScenarioComparison component**
   - Comparare side-by-side Nihao vs Alternative
   - Highlighting diferențelor cheie
   - Vizualizări grafice pentru economii

9. **Creare SavingsVisualization**
   - Chart.js pentru vizualizare economii
   - Breakdown pe categorii (preț, timp, risc, FX)
   - Export rezultate (PDF/CSV)

### Phase 3: Dashboard & Market Integration

10. **Restructurare Dashboard**
    - Adăugare carduri noi pentru oportunități
    - Widget comparativ EUA vs CEA
    - Quick calculator inline
    - Link către calculator complet

11. **Extindere Market Analysis**
    - Secțiune nouă "Arbitrage Analysis"
    - Recomandări swap personalizate
    - Alertă oportunități noi
    - **Dependency**: Modificările depind de endpoint `/api/market/analysis` creat în Phase 1 Step 4

12. **Creare Market Opportunities page**
    - Listă oportunități detectate
    - Filtrare și sortare
    - Acțiuni rapide (calculează beneficiile)

### Phase 4: Educational Content & Storytelling

13. **Creare Benefits page**
    - Secțiune pentru vânzători cu 8 scenarii din cercetare
    - Secțiune pentru cumpărători cu 6 scenarii din cercetare
    - Exemple numerice concrete din documentație
    - Link către calculator pentru scenarii personalizate

14. **Integrare storytelling în componente**
    - Tooltips educaționale cu explicații
    - Modals cu scenarii detaliate
    - Link-uri către documentație relevantă

15. **Actualizare i18n**
    - Traduceri pentru toate noile componente în `src/i18n/locales/*.ts` (en.ts, ro.ts, zh.ts)
    - Exemple și scenarii traduse
    - Documentație educațională tradusă
    - Note: Fișierele i18n sunt `.ts` (TypeScript), nu `.json`

### Phase 5: Polish & Optimization

16. **Optimizare performanță**
    - Caching pentru calcule complexe
    - Lazy loading pentru componente grele
    - Memoization pentru recalculări

17. **Testare end-to-end**
    - Testare scenarii complete din cercetare
    - Validare calcule cu date reale
    - Testare UX pentru flow complet

18. **Documentație**
    - Documentație API pentru noile endpoints
    - Ghid utilizator pentru calculator
    - Exemple de utilizare pentru fiecare scenariu

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `backend/models/value_scenario.py` | CREATE | Model SQLAlchemy pentru scenarii salvate |
| `backend/models/market_opportunity.py` | CREATE | Model SQLAlchemy pentru oportunități |
| `backend/services/value_calculator.py` | CREATE | Service pentru calcule valoare vânzători |
| `backend/services/swap_calculator.py` | CREATE | Service pentru calcule swap și swap ratios |
| `backend/services/market_opportunity_detector.py` | CREATE | Detector automat oportunități |
| `backend/api/calculator.py` | CREATE | Blueprint API pentru calculator (nume actualizat) |
| `backend/api/market_opportunities.py` | CREATE | Blueprint API pentru oportunități |
| `backend/api/market_analysis.py` | CREATE | Blueprint API pentru analiză de piață (NOU) |
| `backend/utils/compliance_detector.py` | CREATE | Utility pentru detectare perioade compliance |
| `backend/scripts/migrate_0026_value_scenarios.py` | CREATE | Migrație baze de date |
| `src/pages/ValueCalculator.tsx` | CREATE | Pagină calculator valoare |
| `src/pages/Benefits.tsx` | CREATE | Pagină educațională avantaje |
| `src/pages/MarketOpportunities.tsx` | CREATE | Pagină oportunități detectate |
| `src/components/ValueCalculator.tsx` | CREATE | Componentă calculator principală |
| `src/components/SellerBenefitsCard.tsx` | CREATE | Card avantaje vânzători |
| `src/components/BuyerBenefitsCard.tsx` | CREATE | Card avantaje cumpărători |
| `src/components/ScenarioComparison.tsx` | CREATE | Comparare scenarii |
| `src/components/SavingsVisualization.tsx` | CREATE | Vizualizare economii |
| `src/components/ArbitrageOpportunityCard.tsx` | CREATE | Card oportunități arbitraj |
| `src/components/SwapRecommendation.tsx` | CREATE | Recomandări swap |
| `src/context/ValueContext.tsx` | CREATE | Context pentru gestionare valoare |
| `src/services/valueCalculatorService.ts` | CREATE | Service frontend calculator |
| `src/services/marketOpportunitiesService.ts` | CREATE | Service frontend oportunități |
| `src/pages/Dashboard.tsx` | MODIFY | Adăugare carduri oportunități și quick calculator |
| `src/pages/Market.tsx` | MODIFY | Adăugare secțiune swap opportunities |
| `src/pages/MarketAnalysis.tsx` | MODIFY | Extindere cu analiză arbitraj (folosește `/api/market/analysis`) |
| `src/App.tsx` | MODIFY | Adăugare rute noi cu protecție corespunzătoare (ProtectedRoute/OnboardingRoute) |
| `src/i18n/locales/en.ts` | MODIFY | Traduceri noi componente |
| `src/i18n/locales/ro.ts` | MODIFY | Traduceri noi componente |
| `src/i18n/locales/zh.ts` | MODIFY | Traduceri noi componente |

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| **Calcule complexe pot fi lente** | Implementare caching agresiv, calcule asincrone, optimizare algoritmi |
| **Date pieței pot fi incomplete** | Fallback la estimări conservatoare, clarificare surse date, disclaimer-uri |
| **Scenarii pot fi prea simplificate** | Documentație clară despre limitări, opțiune pentru input manual avansat |
| **Traduceri pot fi incomplete** | Review exhaustiv traduceri, validare cu vorbitori nativi |
| **Performanță dashboard cu multe widget-uri** | Lazy loading, virtualization, optimizare re-renders |
| **API endpoints noi pot afecta rate limiting** | Configurare rate limits specifice, caching pentru endpoint-uri grele |
| **Migrații baze de date pot eșua** | Backup înainte de migrație, rollback plan, testare pe staging |

## Estimation

**Complexity: Complex**

**Timeline estimat**: 6-8 săptămâni

**Breakdown**:
- Phase 0 (Pre-Implementation): 0.5 săptămâni (decizii, setup, backup)
- Phase 1 (Backend): 2 săptămâni
  - Step 1 (CER→CEA Migration): 0.5 săptămâni ⚠️ **CRITICAL PATH**
  - Step 2 (Database Migration): 0.25 săptămâni
  - Step 3 (Services): 0.75 săptămâni
  - Step 4 (API Endpoints): 0.5 săptămâni
- Phase 2 (Core Components): 2 săptămâni
- Phase 3 (Integration): 1 săptămână
- Phase 4 (Content): 1 săptămână
- Phase 5 (Polish): 1-2 săptămâni

**Resurse necesare**:
- 1 Backend Developer (Python/Flask)
- 1 Frontend Developer (React/TypeScript)
- 1 UX Designer (pentru design componente noi)
- 1 Technical Writer (pentru documentație educațională)

## Success Metrics

- **Adoption Rate**: 70%+ utilizatori activează calculatorul în prima săptămână
- **Engagement**: 50%+ utilizatori salvează cel puțin un scenariu
- **Education**: 80%+ utilizatori citesc cel puțin un scenariu educațional
- **Conversion**: 30%+ utilizatori care calculează beneficiile inițiază proces de onboarding
- **Accuracy**: 95%+ acuratețe calcule comparativ cu scenarii reale din cercetare

## Key Scenarios to Highlight

**Source Documents:**
- Vânzători: `docs/research/CEA-seller-reason.md` (8 scenarii complete)
- Cumpărători: `docs/research/swap-reason.md` (6 scenarii complete)

### Pentru Vânzători CEA (din cercetare)

1. **Liquidity Crisis**: Vânzare 1M CEA - Shanghai: 2-4 săptămâni, impact 10-30%, vs Nihao: 48h, discount 2-3%
   - Source: `CEA-seller-reason.md` - Scenariul 1
2. **Banking Panic**: Deadline decembrie - Shanghai: panic selling la 40 yuan, vs Nihao: buyer of last resort la 55 yuan (+37.5%)
   - Source: `CEA-seller-reason.md` - Scenariul 2
3. **Confidentiality**: SOE mare vânzând 2M CEA - Shanghai: public, impact preț, vs Nihao: OTC discret, premium 10-16%
   - Source: `CEA-seller-reason.md` - Scenariul 5
4. **FX Flexibility**: Necesitate EUR pentru import - Shanghai: RMB only, vs Nihao: settlement EUR direct
   - Source: `CEA-seller-reason.md` - Scenariul 8
5. **Off-Season Trading**: Vânzare noiembrie - Shanghai: piață moartă, vs Nihao: cumpără contra-ciclic
   - Source: `CEA-seller-reason.md` - Scenariul 7
6. **Regulatory Uncertainty Discount**: Risk-averse entities prefer cash now
   - Source: `CEA-seller-reason.md` - Scenariul 4
7. **Cross-Border Arbitrage**: Entități sofisticate monetizează arbitrajul
   - Source: `CEA-seller-reason.md` - Scenariul 6
8. **Information Asymmetry**: Foreign buyers premium pentru acces instant
   - Source: `CEA-seller-reason.md` - Scenariul 3

### Pentru Cumpărători CEA (Swap EUA)

1. **Compliance Optimization**: Multinațională cu operațiuni duale - Swap direct: WFOE €50k-100k, 6-12 luni, vs Nihao: instant, fee 1.5%
   - Source: `swap-reason.md` - Scenariul 1
2. **CBAM Strategy**: Importator UE cu furnizor chinez - Swap direct: complex, vs Nihao: €40/ton economii CBAM
   - Source: `swap-reason.md` - Scenariul 3
3. **Investment Diversification**: Fond deținând EUA - Acces direct CEA: imposibil fără WFOE, vs Nihao: instant exposure
   - Source: `swap-reason.md` - Scenariul 2
4. **Jurisdictional Exit**: Companie chineză ieșind din UE - Vânzare EUA: capital controls 4-8 săptămâni, vs Swap: 48h, zero controls
   - Source: `swap-reason.md` - Scenariul 4
5. **Offshore Treasury Management**: SPV optimization pentru multinaționale
   - Source: `swap-reason.md` - Scenariul 5
6. **Hedging and Portfolio Diversification**: Institutional investors seeking geographic diversification
   - Source: `swap-reason.md` - Scenariul 6

## Technical Considerations

### Calculatoare - Logică de Bază

**Vânzător CEA Calculator**:
```python
def calculate_seller_benefits(volume, current_price, urgency, confidentiality, fx_preference):
    # Shanghai alternative
    market_impact = calculate_market_impact(volume)  # 10-30% pentru volume mari
    execution_time = calculate_execution_time(volume, urgency)  # 2-4 săptămâni normal
    shanghai_price = current_price * (1 - market_impact)
    shanghai_total = shanghai_price * volume
    
    # Nihao offer
    nihao_discount = 0.02 if urgency == 'normal' else 0.03  # 2-3% discount
    nihao_price = current_price * (1 - nihao_discount)
    nihao_execution_time = "48 hours"
    nihao_total = nihao_price * volume
    
    # Benefits
    price_premium = nihao_total - shanghai_total
    time_savings = execution_time - nihao_execution_time
    confidentiality_benefit = True if confidentiality else False
    fx_benefit = fx_preference != 'RMB'
    
    return {
        'total_savings': price_premium,
        'savings_percentage': (price_premium / shanghai_total) * 100,
        'benefits': {...}
    }
```

**Cumpărător Swap Calculator**:
```python
def calculate_buyer_swap_benefits(eua_volume, eua_price, swap_ratio, use_case, has_china_ops):
    # Direct swap costs
    wfoe_setup = 75000 if not has_china_ops else 0  # €50k-100k average
    time_to_market = "6-12 months" if not has_china_ops else "2-4 weeks"
    capital_controls_risk = True
    fx_exposure = eua_volume * eua_price * 0.015  # 1.5% FX spread
    
    # Nihao swap
    nihao_fee = eua_volume * eua_price * 0.015  # 1.5% intermediation
    nihao_execution = "48 hours"
    no_wfoe = True
    no_capital_controls = True
    
    # Benefits calculation
    wfoe_savings = wfoe_setup
    time_value = calculate_time_value(time_to_market, eua_volume * eua_price)
    risk_reduction = "Eliminated capital controls and FX exposure"
    cbam_optimization = calculate_cbam_savings(use_case) if use_case == 'cbam' else 0
    
    total_savings = wfoe_savings + time_value - nihao_fee + cbam_optimization
    
    return {
        'total_savings': total_savings,
        'savings_percentage': (total_savings / (eua_volume * eua_price)) * 100,
        'benefits': {...}
    }
```

### Market Opportunity Detection

```python
# backend/services/market_opportunity_detector.py
from utils.compliance_detector import ComplianceDetector
from services.swap_calculator import SwapCalculator

def detect_arbitrage_opportunities():
    eua_price = get_eua_price()  # €88
    cea_price = get_cea_price()  # 63 yuan (~€8) - din scraper sau API
    
    price_gap = eua_price / cea_price  # ~11x
    
    opportunities = []
    
    # Liquidity crisis detection (China ETS)
    compliance_detector = ComplianceDetector()
    if compliance_detector.is_compliance_period():
        days_until = compliance_detector.days_until_deadline()
        if days_until <= 30:
            opportunities.append({
                'type': 'liquidity_crisis',
                'description': 'Banking deadline approaching - panic selling expected',
                'potential_savings': '10-20% premium for buyers',
                'action': 'Buy CEA now before panic',
                'expires_at': datetime.now() + timedelta(days=days_until)
            })
    
    # Arbitrage opportunity
    swap_calculator = SwapCalculator()
    if price_gap > 10:
        swap_ratio = swap_calculator.calculate_swap_ratio(
            eua_price, cea_price, 
            {'liquidity_premium': 0.2, 'compliance_adjustment': 0.1}
        )
        opportunities.append({
            'type': 'arbitrage',
            'description': f'Price gap {price_gap:.1f}x - swap opportunity',
            'potential_savings': calculate_arbitrage_savings(),
            'swap_ratio': swap_ratio,
            'action': 'Swap EUA → CEA for diversification'
        })
    
    return opportunities
```

### Market Data Sources

**CEA Price Source:**
- Current: Generated from EUA price using discount model (30-50% discount)
- Implementation: `backend/scraper.py` → `scrape_cea_price()` (renamed from `scrape_cer_price`)
- Future: Research Shanghai Environment and Energy Exchange API for real-time data
- Fallback: Historical data collector with generated prices

**Swap Ratio Calculation:**
- Service: `SwapCalculator.calculate_swap_ratio()`
- Base ratio: `eua_price / cea_price` (typically ~11:1)
- Adjustments:
  - Liquidity premium: +0.1-0.3
  - Compliance timing: +0.2-0.5 during Oct-Dec
  - Volume discounts: -0.1-0.2 for large volumes (>1M tons)

**Compliance Period Detection:**
- Utility: `ComplianceDetector`
- Deadline: December 31 each year
- Periods:
  - Panic: Last 30 days before deadline
  - Compliance: October-December (Q4)
  - Normal: January-September (off-season)

## Integration Points

1. **Dashboard Integration**: Widget-uri noi se integrează cu datele existente de preț și portofoliu
2. **Market Data**: Folosește feed-urile existente de preț EUA și CEA pentru calcule
   - EUA: `/api/eua/price` și `/api/eua/history` (există deja)
   - CEA: `/api/cea/price` (renamed from `/api/cer/price` în Phase 1 Step 1) și `/api/cea/history` (renamed from `/api/cer/history`)
   - Market Analysis: `/api/market/analysis` (nou endpoint agregat în Phase 1 Step 4)
3. **User Context**: Folosește datele utilizatorului (KYC status, portfolio) pentru personalizare
   - `User` model: `kyc_status`, `risk_level`, `portfolio` (dacă există)
   - Route protection: `ProtectedRoute` pentru features care necesită KYC approval
4. **Onboarding Flow**: Link către calculator din onboarding pentru demonstrare valoare timpurie
   - `/benefits` page accesibilă prin `OnboardingRoute` (auth only, nu KYC)
5. **Terminology Migration**: Toate referințele CER vor fi migrate la CEA în Phase 1 Step 1 (vezi `0026_RESOLUTION_PLAN.md`)
   - **Dependency Chain**: Step 1 trebuie completat înainte de Step 2-5
6. **Database Models**: Noile modele (`ValueScenario`, `MarketOpportunity`) se integrează cu `User` model existent prin foreign keys

## Pre-Implementation Checklist

Before starting implementation, ensure:

- [ ] Review `0026_RESOLUTION_PLAN.md` for all resolved issues
- [ ] Confirm terminology migration approach (CER → CEA) - **Must be completed in Phase 1 Step 1**
- [ ] Review route protection decisions
- [ ] Verify research scenarios are accessible (`docs/research/CEA-seller-reason.md`, `docs/research/swap-reason.md`)
- [ ] Set up database backup procedure (`cp kyc_database_dev.db kyc_database_dev.db.backup`)
- [ ] Review API endpoint naming conventions (`/api/calculator/...` confirmed)
- [ ] Verify Chart.js is available (or add to dependencies) for `SavingsVisualization` component
- [ ] Review migration script pattern from `backend/scripts/migrate_access_requests_0022.py`
- [ ] Note: i18n files are `.ts` files, not `.json` files

## Future Enhancements

- **AI Recommendations**: Machine learning pentru recomandări swap personalizate
- **Real-time Alerts**: Notificări pentru oportunități noi detectate
- **Historical Analysis**: Analiză istorică a scenariilor calculate pentru optimizare
- **Integration APIs**: API-uri pentru integrare cu sisteme externe (ERP, trading platforms)

