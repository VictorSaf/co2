# Feature 0013: Price History Default, Market Offers Enhancement, Onboarding Standardization, and Profile Page

## Description

This feature addresses four main areas:
1. **Price History Default**: Change certificate price history default timeframe from 1 month to show more data (3 months or all available)
2. **Market Offers Enhancement**: Increase number of market offers with smaller price differences and more varied volumes (both larger and smaller than current)
3. **Onboarding Process Standardization**: Fix, clarify, and standardize the onboarding/KYC process to resolve "Failed to load KYC status" error
4. **Profile Page**: Implement a complete and useful profile page that displays user information and onboarding process status

## Files to Modify

### Frontend Files

#### Price History Default Changes
- `src/pages/Dashboard.tsx`
  - Modify chart data filtering to default to 3 months or all available data instead of showing all data (which may appear as 1 month if limited data exists)
  - Add timeframe selector similar to MarketAnalysis page, or filter to show last 3 months by default
  - Function: `useEffect` hook that creates the chart (lines 21-127)

- `src/pages/MarketAnalysis.tsx`
  - Verify default timeframe is appropriate (currently '3M' - line 123)
  - Ensure this is the desired default or adjust if needed

#### Market Offers Enhancement
- `src/components/MarketOffersSync.tsx`
  - Increase number of offers generated (currently 10 CER, 8 EUA - lines 33, 51)
  - Reduce price variation range to create smaller price differences between offers
  - Modify volume generation to include both larger and smaller volumes than current range
  - Functions to modify:
    - Initial offer generation (lines 33-67)
    - Offer recreation logic (lines 117-151)
    - Price variation calculation (lines 36-38, 54-56, 121, 137)
    - Volume generation (lines 45, 63, 127, 143, 338)

- `src/context/CertificateContext.tsx`
  - Update `generateInitialOffers` function (lines 25-63)
  - Adjust price variation and volume ranges to match new requirements

#### Onboarding Process Standardization
- `src/pages/Onboarding.tsx`
  - Improve error handling in `loadKYCStatus` function (lines 80-116)
  - Better handle 404 errors (user hasn't started onboarding) vs other errors
  - Standardize error messages and user feedback
  - Ensure form validation is clear and consistent
  - Function: `loadKYCStatus` (lines 80-116)
  - Function: `handleStartOnboarding` (lines 118-131)

- `src/services/kycService.ts`
  - Review `getKYCStatus` function error handling (lines 224-236)
  - Ensure proper error propagation and user-friendly error messages
  - Add better error context for debugging

- `backend/api/kyc.py`
  - Review `/register` endpoint (lines 52-152)
  - Ensure consistent error responses
  - Verify user creation logic in development mode (lines 92-109)
  - Standardize validation and error messages

- `backend/api/kyc.py`
  - Review `/status` endpoint (if exists) or ensure proper error handling
  - Ensure 404 is returned appropriately when user hasn't started onboarding

#### Profile Page Implementation
- `src/pages/Profile.tsx` (NEW FILE)
  - Create new Profile page component
  - Display user information (username, email, company name, address, contact person, phone)
  - Display KYC/onboarding status with visual indicators
  - Show current workflow step and progress
  - Display uploaded documents status
  - Show EU ETS registry verification status
  - Display suitability and appropriateness assessment completion status
  - Link to onboarding page if not completed
  - Use existing KYC types from `src/types/kyc.ts`
  - Use `getKYCStatus` from `src/services/kycService.ts`
  - Use `useAuth` hook for user data

- `src/App.tsx`
  - Add route for `/profile` page (after line 116)
  - Use `ProtectedRoute` wrapper (similar to other protected routes)
  - Import Profile component (add to lazy imports around line 21)

- `src/components/Header.tsx`
  - Verify profile link exists (line 652) - already exists, ensure it works correctly

- `src/i18n/locales/en.ts`, `src/i18n/locales/ro.ts`, `src/i18n/locales/zh.ts`
  - Add translation keys for Profile page:
    - `profile`, `profileTitle`, `profileSubtitle`
    - `userInformation`, `companyName`, `address`, `contactPerson`, `phone`, `email`
    - `kycStatus`, `onboardingStatus`, `currentStep`, `workflowProgress`
    - `documentsStatus`, `euEtsVerification`, `suitabilityAssessment`, `appropriatenessAssessment`
    - `completeOnboarding`, `viewDocuments`, `editProfile`
    - Status labels: `pending`, `inProgress`, `approved`, `rejected`, `notStarted`

### Backend Files (if needed)

- `backend/api/kyc.py`
  - Ensure `/status` endpoint properly handles all cases
  - Return consistent response format with all required KYC data
  - Function: Status endpoint (verify exists and works correctly)

## Implementation Details

### Price History Default

**Current Behavior**: Dashboard shows all available price history data, but if limited data exists, it may appear as only 1 month.

**Desired Behavior**: 
- Filter price history to show last 3 months by default in Dashboard
- Or add timeframe selector similar to MarketAnalysis page
- Ensure chart displays meaningful data range

**Algorithm**:
1. In Dashboard component, filter `marketStats.priceHistory` to last 3 months before creating chart
2. Use `subMonths(new Date(), 3)` to calculate start date
3. Filter entries where `entry.date >= startDate`
4. Update chart data with filtered results

### Market Offers Enhancement

**Current Behavior**:
- 10 CER offers, 8 EUA offers
- Price variation: CER offers vary by up to 3 EUR above live price (line 38), EUA offers vary by up to 5 EUR above live price (line 56)
- Volume range: CER 1000-6000 tons (line 45), EUA 500-3500 tons (line 63)

**Desired Behavior**:
- More offers: Increase to 15-20 CER offers, 12-15 EUA offers
- Smaller price differences: Reduce variation to 0.5-1.5 EUR for CER, 1-2 EUR for EUA
- Varied volumes: Include both smaller (500-2000 for CER, 200-1000 for EUA) and larger (8000-15000 for CER, 5000-10000 for EUA) volumes

**Algorithm**:
1. Increase offer count in `MarketOffersSync.tsx`:
   - CER: Change from `Array(10)` to `Array(18)` (or configurable)
   - EUA: Change from `Array(8)` to `Array(15)` (or configurable)
2. Reduce price variation:
   - CER: Change from `Math.random() * 3 + 0.5` to `Math.random() * 1 + 0.5` (0.5-1.5 EUR)
   - EUA: Change from `Math.random() * 5 + 1` to `Math.random() * 1 + 1` (1-2 EUR)
3. Create volume distribution:
   - Use weighted random selection: 30% small volumes, 40% medium volumes, 30% large volumes
   - Small: CER 500-2000, EUA 200-1000
   - Medium: CER 2000-6000, EUA 1000-3500 (current range)
   - Large: CER 8000-15000, EUA 5000-10000

### Onboarding Process Standardization

**Current Issue**: "Failed to load KYC status" error appears when user hasn't started onboarding or when API call fails.

**Desired Behavior**:
- Clear distinction between "user hasn't started onboarding" (404) and actual errors
- Better error messages for users
- Consistent error handling across all onboarding endpoints
- Proper validation and user feedback

**Standardization Steps**:
1. **Error Handling**:
   - 404 errors should be handled gracefully as "not started" state, not as errors
   - Other errors should show user-friendly messages
   - Log detailed errors server-side for debugging
   
2. **API Consistency**:
   - Ensure all KYC endpoints return consistent error format
   - Use `standard_error_response()` helper consistently
   - Include error codes for frontend handling

3. **User Experience**:
   - Show clear onboarding form when status is not available
   - Display helpful error messages with actionable steps
   - Prevent form submission with invalid data

4. **Validation**:
   - Frontend validation before API calls
   - Backend validation with clear error messages
   - Consistent field requirements across all forms

### Profile Page Implementation

**Page Structure**:
1. **User Information Section**:
   - Username, email
   - Company name, address, contact person, phone
   - Display from user object and KYC data

2. **Onboarding Status Section**:
   - KYC status badge with color coding (pending/in-progress/approved/rejected)
   - Current workflow step indicator
   - Progress bar showing completion percentage
   - Link to onboarding page if not completed

3. **Document Status**:
   - List of required documents
   - Upload status for each document (uploaded/pending/verified/rejected)
   - Link to upload documents

4. **Assessment Status**:
   - EU ETS Registry verification status
   - Suitability assessment completion status
   - Appropriateness assessment completion status

5. **Actions**:
   - "Continue Onboarding" button if not completed
   - "Edit Profile" button (future feature - can be placeholder)
   - Link to view documents

**Data Flow**:
1. Load user data from `useAuth()` hook
2. Load KYC status using `getKYCStatus()` from `kycService`
3. Load documents using `getDocuments()` from `kycService`
4. Display all information in organized sections
5. Handle loading and error states

**UI/UX**:
- Use card-based layout similar to Dashboard
- Dark mode support (use existing dark mode classes)
- Responsive design (mobile-friendly)
- Loading states and error handling
- Clear visual indicators for status (badges, progress bars)

## Dependencies

- Existing KYC service functions (`getKYCStatus`, `getDocuments`)
- Existing KYC types (`UserKYC`, `KYCWorkflow`, `KYCDocument`, etc.)
- Existing auth context (`useAuth` hook)
- Existing translation system (i18n)
- Existing theme system (dark mode)

## Testing Considerations

1. **Price History**: Verify chart shows correct date range, handles edge cases (no data, limited data)
2. **Market Offers**: Verify offer count, price ranges, volume distribution
3. **Onboarding**: Test error scenarios (404, network errors, validation errors)
4. **Profile Page**: Test with different KYC statuses, verify all data displays correctly, test navigation

## Notes

- Profile page route already exists in Header component (line 652), just needs the page implementation
- Onboarding error may be due to missing user_id in request or API endpoint issues - needs investigation
- Market offers enhancement should maintain the rule that best price matches live price
- Price history change should maintain chart performance with larger datasets

