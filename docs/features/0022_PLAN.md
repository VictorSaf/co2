# Plan: Access Request Form Enhancements

## Description

Enhance the access request form on the login page with additional information icons, a new position field, mandatory reference field, and a confirmation step before final submission. The form will guide users with helpful tooltips and require confirmation of entered data before submission.

## Requirements

### Form Field Changes

1. **Entity Field** - Add info icon that displays tooltip: "Corporate name"
2. **Contact Field** - Add info icon that displays tooltip: "Corporate e-mail. Don't use personal e-mails!"
3. **New Position Field** - Add new field "YOUR POSITION IN THE ENTITY" (no info icon, required)
4. **Reference Field** - Remove "(optional)" label, make field required, add info icon with tooltip: "Who introduces you to us?"

### Validation

- Before initial Submit button click, verify all fields are completed (entity, contact, position, reference)
- All fields must be non-empty after trimming whitespace
- Contact field must be valid email format

### Confirmation Flow

1. After initial Submit, display confirmation screen showing all entered data in the same graphical interface style
2. Confirmation screen displays:
   - Entity
   - Contact
   - Position
   - Reference
3. User is asked to confirm data is correct
4. Confirmation screen has two buttons:
   - **Edit** - Returns to form with all data pre-filled
   - **Submit** - Final submission to backend
5. After final Submit, show success message: "You will be contacted as soon as possible"

## Files to Modify

### Backend

1. **`backend/models/access_request.py`**
   - Add `position` field: `db.Column(db.String(100), nullable=False)`
   - Update `to_dict()` method to include `position` field
   - Make `reference` field non-nullable: `db.Column(db.String(100), nullable=False)`

2. **`backend/api/access_requests.py`**
   - Update `create_access_request()` endpoint:
     - Add validation for `position` field (required, max 100 chars)
     - Make `reference` field required (remove optional handling)
     - Add `position` to request body documentation
     - Update sanitization to include `position` field

3. **Database Migration**
   - Add `position` column to `access_requests` table (NOT NULL, VARCHAR(100))
   - Update existing records: set `position` to empty string or default value
   - Make `reference` column NOT NULL
   - Update existing NULL `reference` values to empty string

### Frontend

1. **`src/pages/Login.tsx`**
   - Add state for `position` field
   - Add state for confirmation step (`showConfirmation`)
   - Add state for confirmation data object
   - Add `InformationCircleIcon` import from `@heroicons/react/24/outline`
   - Modify access request form:
     - Add info icon next to Entity label with tooltip
     - Add info icon next to Contact label with tooltip
     - Add new Position input field (required, no info icon)
     - Update Reference field: remove "(optional)", add `required` attribute, add info icon with tooltip
   - Update `handleAccessRequest()` function:
     - Add validation for `position` field
     - Add validation for `reference` field (now required)
     - Instead of submitting immediately, show confirmation screen with entered data
   - Add new `handleConfirmationSubmit()` function:
     - Submits data to backend API
     - Shows final success message
     - Closes modal and resets form
   - Add new `handleEdit()` function:
     - Returns to form view
     - Pre-fills all fields with confirmation data
   - Add confirmation screen UI:
     - Display all entered data (Entity, Contact, Position, Reference)
     - Same styling as form modal
     - Two buttons: Edit and Submit
   - Update form validation to check all fields before showing confirmation

2. **`src/services/accessRequestService.ts`**
   - Update `AccessRequestData` interface to include `position: string` and make `reference: string` (remove optional)

3. **`src/i18n/locales/en.ts`**
   - Add translation keys:
     - `entityInfo`: "Corporate name"
     - `contactInfo`: "Corporate e-mail. Don't use personal e-mails!"
     - `position`: "Your Position in the Entity"
     - `positionPlaceholder`: "YOUR POSITION IN THE ENTITY"
     - `referenceInfo`: "Who introduces you to us?"
     - `confirmData": "Please confirm that the following information is correct:"
     - `edit": "Edit"
     - `confirmSubmit": "Submit"
     - `willContactSoon": "You will be contacted as soon as possible"

4. **`src/i18n/locales/ro.ts`**
   - Add Romanian translations for all new keys

5. **`src/i18n/locales/zh.ts`**
   - Add Chinese translations for all new keys

### Admin Components (Update for new field)

1. **`src/components/admin/AccessRequestsManagement.tsx`**
   - Update to display `position` field in request details modal
   - Update table/list view if needed to show position

2. **`src/services/adminService.ts`**
   - Update `AccessRequest` interface to include `position: string`

## Implementation Details

### Info Icon Tooltip Implementation

- Use `InformationCircleIcon` from Heroicons
- Position icon next to field label
- Tooltip appears on hover/click
- Tooltip styled consistently with existing modal design
- Use dark mode variants for tooltip background

### Confirmation Screen Design

- Same modal container styling as form
- Display entered data in read-only format (styled inputs or text blocks)
- Clear visual hierarchy showing this is a confirmation step
- Edit button: Secondary style (similar to Cancel button)
- Submit button: Primary style (same as form Submit button)

### Form State Management

- Use React state to track:
  - Form fields: `entity`, `contact`, `position`, `reference`
  - Confirmation state: `showConfirmation` (boolean)
  - Confirmation data: `confirmationData` (object with all fields)
- When Edit is clicked, set `showConfirmation` to false and restore form values
- When confirmation Submit is clicked, call API and show final success message

### Validation Flow

1. User fills form
2. User clicks Submit
3. Frontend validates all fields (required + email format)
4. If validation passes, show confirmation screen
5. User reviews data
6. User clicks Edit (returns to form) or Submit (sends to backend)
7. After backend submission, show final success message

### Backend Validation

- `entity`: Required, max 200 chars, sanitized
- `contact`: Required, valid email format, max 120 chars, sanitized
- `position`: Required, max 100 chars, sanitized
- `reference`: Required, max 100 chars, sanitized

### Error Handling

- If validation fails before confirmation, show error messages in form
- If API call fails during final submission, show error message in confirmation screen
- Allow user to Edit and retry after error

## Database Migration Considerations

Since this modifies the database schema:

1. **New `position` field**: Add column with NOT NULL constraint
   - For existing records, set default value (e.g., empty string or "Not specified")
   - Consider migration script to handle existing data

2. **`reference` field**: Change from nullable to NOT NULL
   - Update existing NULL values to empty string before adding constraint
   - Migration script needed to update existing records

## Testing Considerations

1. Test form validation with all fields empty
2. Test form validation with missing individual fields
3. Test email format validation
4. Test confirmation screen displays correct data
5. Test Edit button returns to form with correct data
6. Test final submission flow
7. Test error handling during API submission
8. Test with existing admin components to ensure position field displays correctly
9. Test tooltip display and interaction
10. Test dark mode styling for all new elements

## UI/UX Notes

- Maintain consistent styling with existing Login page modal design
- Info icons should be clearly visible but not intrusive
- Tooltips should be accessible (keyboard navigation, screen readers)
- Confirmation screen should clearly indicate this is a review step
- Success message after final submission should be prominent and clear
- All text should use i18n translation keys for multi-language support
