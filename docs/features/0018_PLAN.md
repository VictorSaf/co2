# Plan: Tracking Last Source and Last Price per Data Source

## Context

Currently, the Price Update Monitoring page shows "Unknown" for the last source of EUA spot prices. The user wants to:
1. See the actual last source that provided the price (not "Unknown")
2. For each data source listed in settings, display the last price obtained from that specific source

## Technical Requirements

### Backend Changes

#### 1. Modify `backend/scraper.py` - ICEScraper class

**File**: `backend/scraper.py`

**Changes**:
- Modify `scrape_ice_price()` method to track which source succeeded:
  - Map each source function to a human-readable source name
  - When a source succeeds, add `'source'` field to the returned dictionary with the source name
  - Source name mapping:
    - `_fetch_from_ice_spot` → "ICE (Intercontinental Exchange)"
    - `_fetch_from_free_api` → "Free API (realistic simulation)"
    - `_fetch_from_tradingview` → "TradingView"
    - `_fetch_from_investing` → "Investing.com"
    - `_fetch_from_marketwatch` → "MarketWatch"
    - `_fetch_from_ice_public` → "ICE public pages"
  - When using cached price (fallback), set source to "Cached" or "Unknown"
- Modify each `_fetch_from_*` method to optionally accept and return source name, or add source name in `scrape_ice_price()` after successful fetch
- Modify `get_cached_price()` to include source information if available

**Algorithm**:
1. Create a mapping dictionary: `source_map = {function: "Source Name"}`
2. In the loop that tries sources, when `price_data` is successfully returned, add `price_data['source'] = source_map[source_func]`
3. Return price_data with source field included

#### 2. Modify `backend/app.py` - Price caching and tracking

**File**: `backend/app.py`

**Changes**:
- Add a new global dictionary to track last price per source:
  ```python
  source_price_history = {
      'ICE (Intercontinental Exchange)': {'price': None, 'timestamp': None},
      'Free API (realistic simulation)': {'price': None, 'timestamp': None},
      'TradingView': {'price': None, 'timestamp': None},
      'Investing.com': {'price': None, 'timestamp': None},
      'MarketWatch': {'price': None, 'timestamp': None},
      'ICE public pages': {'price': None, 'timestamp': None},
      'OilPriceAPI (fallback)': {'price': None, 'timestamp': None},
  }
  ```
- Modify `get_eua_price()` endpoint:
  - When `price_data` is successfully fetched, extract `source` field
  - Update `source_price_history[source]` with price and timestamp
  - Ensure `cached_response` includes the `source` field
- Modify `refresh_price()` endpoint:
  - Same changes as `get_eua_price()` - track source and update history
- Modify `get_price_updates_status()` endpoint:
  - Include `lastSource` from `cached_response.get('source', 'Unknown')`
  - Add new field `sourcePrices` to EUA section:
    ```python
    'sourcePrices': [
        {
            'source': 'ICE (Intercontinental Exchange)',
            'lastPrice': price or None,
            'lastUpdate': timestamp or None
        },
        # ... for each source
    ]
    ```
  - Only include sources that have a price (filter out None values, or show all with None if never used)

**Note**: The `source_price_history` dictionary should persist across requests (in-memory is fine for now, but consider database storage for production).

#### 3. Handle OilPriceAPI source

**File**: `backend/scraper.py` - AlternativePriceSource class

**Changes**:
- Modify `fetch_from_oilprice_api()` to include `'source': 'OilPriceAPI (fallback)'` in returned dictionary

**File**: `backend/app.py`

**Changes**:
- When calling `alternative_source.fetch_from_oilprice_api()`, ensure the returned data includes source field
- Update `source_price_history` for OilPriceAPI when this source succeeds

### Frontend Changes

#### 4. Modify `src/services/adminService.ts` - Type definitions

**File**: `src/services/adminService.ts`

**Changes**:
- Update `PriceUpdateStatus` interface:
  - Add `lastPrice?: number` to `eua` section (for the current last price)
  - Add `sourcePrices?: Array<{source: string, lastPrice: number | null, lastUpdate: string | null}>` to `eua` section

#### 5. Modify `src/components/admin/PriceUpdateMonitoring.tsx` - Display component

**File**: `src/components/admin/PriceUpdateMonitoring.tsx`

**Changes**:
- Display `lastSource` value (already exists, but will now show actual source instead of "Unknown")
- Add display for `lastPrice` from current cached response (if available)
- Modify the "Data Sources" section to show last price per source:
  - Change from simple list to a table or detailed list
  - For each source in `status.eua.sourcePrices` (if available), display:
    - Source name
    - Last price obtained from that source (or "N/A" if never used)
    - Last update timestamp (or "Never" if never used)
  - Format: Show price with currency (€XX.XX) and formatted date
  - Visual distinction: Highlight the source that matches `lastSource` (e.g., bold or different color)

**UI Layout**:
- Keep existing grid layout for main info (polling interval, cache duration, etc.)
- Replace the simple numbered list of data sources with a more detailed display
- Consider using a table or card-based layout for source prices
- Show "Last Price" field next to "Last Source" in the main grid

### Translation Keys

**File**: `src/i18n/locales/en.ts`, `src/i18n/locales/ro.ts`, `src/i18n/locales/zh.ts`

**New keys needed**:
- `lastPrice`: "Last Price"
- `sourcePrices`: "Source Prices"
- `neverUsed`: "Never Used" (for sources that haven't been used yet)
- `priceFromSource`: "Price from {source}" (optional, for detailed display)

## Implementation Notes

1. **Source Name Consistency**: Ensure source names match exactly between:
   - `scraper.py` (when setting source field)
   - `app.py` (source_price_history keys and API response)
   - Frontend display (dataSources list)

2. **Backward Compatibility**: The API response should still work if `source` field is missing (fallback to "Unknown")

3. **Performance**: Tracking per-source prices adds minimal overhead (just dictionary updates)

4. **Data Persistence**: Currently using in-memory storage. For production, consider:
   - Database table for source price history
   - Redis cache for faster access
   - Periodic cleanup of old entries

5. **Error Handling**: If a source fails, don't update its history (keep last known price/timestamp)

## Files to Modify

1. `backend/scraper.py` - Add source tracking to ICEScraper
2. `backend/app.py` - Add source_price_history tracking and update API response
3. `src/services/adminService.ts` - Update TypeScript interfaces
4. `src/components/admin/PriceUpdateMonitoring.tsx` - Update UI to display source prices
5. `src/i18n/locales/en.ts` - Add translation keys
6. `src/i18n/locales/ro.ts` - Add translation keys
7. `src/i18n/locales/zh.ts` - Add translation keys

## Testing Considerations

1. Test that source is correctly identified when each source succeeds
2. Test that source_price_history is updated correctly
3. Test that API response includes sourcePrices array
4. Test that frontend displays source prices correctly
5. Test fallback scenarios (cached price, all sources fail)
6. Test that "Unknown" is shown when no source information is available

