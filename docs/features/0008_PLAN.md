# Plan: Client Onboarding și KYC pentru Trading Certificate CO2

## Descriere

Implementarea unui proces complet și eficient de înrolare a clienților (onboarding) pentru platforma de tranzacționare a certificatelor de CO2, conform cerințelor specifice industriei. Procesul va include verificări KYC (Know Your Customer), AML (Anti-Money Laundering), verificarea contului EU ETS Registry, evaluarea de adecvare (suitability/appropriateness) conform MiFID II, și un workflow multi-etapă de aprobare.

## Context Platformă

Platforma Nihao Carbon Certificates permite tranzacționarea a două tipuri de certificate:
- **CER (Chinese)**: Certificate chinezești care necesită conversie în EUA
- **EUA (European)**: Certificate europene gata pentru verificare și surrender

Platforma operează în conformitate cu reglementările EU ETS și necesită verificări stricte pentru participanți.

## Cerințe Specifice Industrie

### Documente Obligatorii pentru Clienți Juridici

1. **Certificat Constatator** - Emis de Oficiul Registrului Comerțului, original sau copie, cu vechime maximă 90 de zile
2. **Ultimul Bilanț Contabil** - Pentru evaluarea situației financiare
3. **Certificat de Înregistrare Fiscală** - Confirmare cod fiscal
4. **Dovadă Cont EU ETS Registry** - Dovadă că clientul deține un cont deschis în Registrul Național al Emisiilor de Gaze cu Efect de Seră dintr-o țară membră UE
5. **Împuternicire Reprezentant Legal** - Pentru persoanele autorizate să acceseze platforma în numele companiei

### Verificări KYC/AML

1. **Verificare Identitate** - Validare documente oficiale, verificare autenticitate
2. **Screening Sancțiuni** - Verificare liste sancțiuni internaționale/naționale (UN, EU, OFAC, etc.)
3. **PEP Screening** - Verificare dacă persoanele sunt Politically Exposed Persons
4. **Evaluare Riscuri** - Clasificare clienți pe baza riscului (Low, Medium, High)
5. **Verificare Beneficiari Reali** - Identificare și verificare beneficiari reali pentru entități juridice
6. **Monitorizare Continuă** - Re-verificare periodică și actualizare informații

### Cerințe EU ETS

1. **Verificare Cont Registry** - Validare că clientul deține cont activ în EU ETS Registry
2. **Verificare Eligibilitate Trading** - Confirmare că entitatea este eligibilă pentru trading certificate CO2
3. **Verificare Compliance** - Asigurare că clientul respectă cerințele EU ETS

### Evaluare Suitability/Appropriateness (MiFID II)

1. **Suitability Assessment** - Pentru clienți care solicită servicii de investiții personalizate
2. **Appropriateness Assessment** - Pentru toți clienții care tranzacționează instrumente financiare
3. **Evaluare Cunoștințe** - Testare cunoștințe despre certificate CO2, riscuri, piață
4. **Evaluare Experiență** - Verificare experiență anterioară în trading certificate CO2
5. **Evaluare Obiective** - Înțelegere obiective client (compliance, hedging, investiție)
6. **Evaluare Capacitate Financiară** - Verificare că clientul poate suporta riscurile

## Fișiere și Funcții de Modificat/Creat

### Backend - Noi Fișiere

#### `backend/models/user.py`
- Model `User` extins cu câmpuri KYC:
  - `kyc_status`: Enum (pending, in_review, approved, rejected, needs_update)
  - `risk_level`: Enum (low, medium, high)
  - `kyc_submitted_at`: DateTime
  - `kyc_approved_at`: DateTime
  - `kyc_reviewed_by`: String (ID reviewer)
  - `kyc_rejection_reason`: Text (opțional)
  - `kyc_documents`: JSON (metadata documente încărcate)
  - `eu_ets_registry_account`: String (număr cont registry)
  - `eu_ets_registry_verified`: Boolean
  - `suitability_assessment`: JSON (rezultate evaluare)
  - `appropriateness_assessment`: JSON (rezultate evaluare)
  - `beneficial_owners`: JSON (lista beneficiari reali)
  - `pep_status`: Boolean
  - `sanctions_check_status`: Enum (pending, cleared, flagged)
  - `sanctions_check_date`: DateTime
  - `last_kyc_review`: DateTime

#### `backend/models/kyc_document.py`
- Model `KYCDocument`:
  - `id`: UUID
  - `user_id`: ForeignKey(User)
  - `document_type`: Enum (company_registration, financial_statement, tax_certificate, eu_ets_proof, power_of_attorney, id_document, address_proof, beneficial_ownership)
  - `file_path`: String
  - `file_name`: String
  - `file_size`: Integer
  - `mime_type`: String
  - `uploaded_at`: DateTime
  - `verified_at`: DateTime
  - `verification_status`: Enum (pending, verified, rejected)
  - `verification_notes`: Text
  - `verified_by`: String (ID reviewer)

#### `backend/models/kyc_workflow.py`
- Model `KYCWorkflow`:
  - `id`: UUID
  - `user_id`: ForeignKey(User)
  - `current_step`: Enum (document_collection, identity_verification, sanctions_check, eu_ets_verification, suitability_assessment, appropriateness_assessment, final_review, approved, rejected)
  - `status`: Enum (in_progress, completed, rejected, on_hold)
  - `started_at`: DateTime
  - `completed_at`: DateTime
  - `assigned_reviewer`: String (ID reviewer)
  - `workflow_data`: JSON (date intermediare workflow)
  - `notes`: Text

#### `backend/api/kyc.py`
- Endpoint `POST /api/kyc/register` - Începe procesul de onboarding
- Endpoint `POST /api/kyc/documents/upload` - Încărcare documente KYC
- Endpoint `GET /api/kyc/documents` - Listare documente încărcate
- Endpoint `DELETE /api/kyc/documents/<document_id>` - Ștergere document
- Endpoint `POST /api/kyc/submit` - Trimite dosarul pentru review
- Endpoint `GET /api/kyc/status` - Verifică status KYC
- Endpoint `POST /api/kyc/eu-ets-verify` - Verificare cont EU ETS Registry
- Endpoint `POST /api/kyc/suitability-assessment` - Completează evaluare suitability
- Endpoint `POST /api/kyc/appropriateness-assessment` - Completează evaluare appropriateness
- Endpoint `GET /api/kyc/workflow` - Obține status workflow curent

#### `backend/api/admin_kyc.py` (pentru admini/compliance)
- Endpoint `GET /api/admin/kyc/pending` - Listă dosare în așteptare
- Endpoint `GET /api/admin/kyc/<user_id>` - Detalii dosar KYC
- Endpoint `POST /api/admin/kyc/<user_id>/approve` - Aprobare dosar
- Endpoint `POST /api/admin/kyc/<user_id>/reject` - Respingere dosar cu motiv
- Endpoint `POST /api/admin/kyc/<user_id>/request-update` - Solicită actualizare documente
- Endpoint `POST /api/admin/kyc/<user_id>/verify-document/<document_id>` - Verificare document individual
- Endpoint `POST /api/admin/kyc/<user_id>/sanctions-check` - Rulare screening sancțiuni
- Endpoint `POST /api/admin/kyc/<user_id>/set-risk-level` - Setare nivel risc

#### `backend/services/sanctions_checker.py`
- Funcție `check_sanctions(name, date_of_birth, nationality)` - Verificare liste sancțiuni
- Integrare cu servicii externe (World-Check, Dow Jones, sau API-uri publice)
- Funcție `check_pep(name, date_of_birth, nationality)` - Verificare PEP status

#### `backend/services/eu_ets_verifier.py`
- Funcție `verify_registry_account(account_number, country)` - Verificare cont EU ETS Registry
- Integrare cu API-uri registry (dacă disponibile) sau verificare manuală

#### `backend/services/suitability_assessor.py`
- Funcție `assess_suitability(user_data, investment_objectives, risk_tolerance, experience)` - Evaluare suitability
- Calculare scor și recomandare produse

#### `backend/services/appropriateness_assessor.py`
- Funcție `assess_appropriateness(user_data, knowledge_test_results, experience_level)` - Evaluare appropriateness
- Determinare dacă clientul poate tranzacționa certificate CO2

#### `backend/utils/document_validator.py`
- Funcție `validate_document(file, document_type)` - Validare format, mărime, tip
- Funcție `extract_text_from_pdf(file_path)` - Extragere text pentru verificare
- Funcție `check_document_expiry(document_type, file)` - Verificare valabilitate documente

### Frontend - Noi Fișiere

#### `src/pages/Onboarding.tsx`
- Pagină principală onboarding cu stepper multi-etapă
- Etape:
  1. Informații de bază (nume companie, adresă, contact)
  2. Încărcare documente KYC
  3. Verificare EU ETS Registry
  4. Evaluare Suitability/Appropriateness
  5. Review și submit
  6. Status așteptare aprobare

#### `src/components/onboarding/OnboardingStepper.tsx`
- Componentă stepper pentru navigare între etape
- Indicatori vizuali progres
- Validare înainte de trecere la următoarea etapă

#### `src/components/onboarding/DocumentUpload.tsx`
- Componentă pentru încărcare documente
- Drag & drop support
- Preview documente
- Validare în timp real
- Progress bar pentru upload
- Listă documente încărcate cu status

#### `src/components/onboarding/EUETSRegistryForm.tsx`
- Formular pentru introducere date cont EU ETS Registry
- Câmpuri: număr cont, țară registry, nume registry
- Buton verificare automată (dacă API disponibil)
- Afișare status verificare

#### `src/components/onboarding/SuitabilityAssessment.tsx`
- Formular evaluare suitability
- Întrebări despre:
  - Obiective investiționale
  - Toleranță la risc
  - Experiență trading
  - Cunoștințe despre certificate CO2
  - Capacitate financiară
- Calculare scor și afișare recomandări

#### `src/components/onboarding/AppropriatenessAssessment.tsx`
- Formular evaluare appropriateness
- Test cunoștințe despre:
  - Certificate CO2 (CER vs EUA)
  - Riscuri asociate
  - Piața carbon
  - Reglementări EU ETS
- Evaluare experiență anterioară
- Rezultat: aprobat/respins/necesită educație

#### `src/components/onboarding/KYCStatus.tsx`
- Componentă pentru afișare status KYC
- Timeline progres
- Notificări pentru acțiuni necesare
- Link către documente necesare

#### `src/components/admin/KYCReview.tsx` (pentru admini)
- Dashboard pentru review dosare KYC
- Filtrare: status, nivel risc, data
- Detalii dosar complet
- Acțiuni: aprobare, respingere, solicitare actualizare
- Istoric modificări

#### `src/services/kycService.ts`
- Funcție `startOnboarding(userData)` - Începe procesul
- Funcție `uploadDocument(file, documentType)` - Încărcare document
- Funcție `getKYCStatus()` - Obține status curent
- Funcție `submitKYC()` - Trimite dosar pentru review
- Funcție `verifyEUETSAccount(accountData)` - Verificare cont registry
- Funcție `submitSuitabilityAssessment(answers)` - Trimite evaluare suitability
- Funcție `submitAppropriatenessAssessment(answers)` - Trimite evaluare appropriateness

#### `src/types/kyc.ts`
- Tipuri TypeScript pentru:
  - `KYCStatus`
  - `DocumentType`
  - `RiskLevel`
  - `WorkflowStep`
  - `KYCDocument`
  - `KYCWorkflow`
  - `SuitabilityAssessment`
  - `AppropriatenessAssessment`
  - `EUETSAccount`

### Fișiere de Modificat

#### `src/types/index.ts`
- Extindere tip `User` cu câmpuri KYC:
  - `kycStatus: KYCStatus`
  - `riskLevel: RiskLevel`
  - `kycDocuments: KYCDocument[]`
  - `euETSRegistryAccount?: string`
  - `euETSRegistryVerified: boolean`

#### `src/context/AuthContext.tsx`
- Adăugare verificare KYC status la login
- Redirecționare către onboarding dacă KYC incomplet
- Funcție `checkKYCStatus()` - Verificare status KYC

#### `src/App.tsx`
- Adăugare rute:
  - `/onboarding` - Pagină onboarding
  - `/onboarding/status` - Status KYC
  - `/admin/kyc` - Dashboard admin KYC (protejat)
- Protecție rute: utilizatorii cu KYC incomplet redirecționați către onboarding

#### `src/pages/Login.tsx`
- Adăugare link către înregistrare/onboarding pentru utilizatori noi
- Mesaj informativ despre procesul KYC

#### `src/components/Header.tsx`
- Badge/indicator status KYC în profil
- Link către status KYC dacă în proces

#### `src/i18n/locales/en.ts`, `ro.ts`, `zh.ts`
- Adăugare traduceri pentru:
  - Etape onboarding
  - Tipuri documente
  - Mesaje status KYC
  - Întrebări suitability/appropriateness
  - Mesaje erori/validare
  - Instrucțiuni utilizator

## Algoritmi și Workflow

### Workflow Onboarding Complet

1. **Înregistrare Inițială**
   - Utilizator se înregistrează cu email/username și parolă
   - Creare cont cu `kyc_status = 'pending'`
   - Creare workflow cu `current_step = 'document_collection'`
   - Redirecționare către `/onboarding`

2. **Colectare Documente**
   - Utilizatorul încarcă documentele obligatorii:
     - Certificat constatator (max 90 zile)
     - Bilanț contabil
     - Certificat fiscal
     - Dovadă cont EU ETS Registry
     - Împuternicire reprezentant legal
   - Validare automată: format, mărime, tip
   - Stocare securizată documente
   - Actualizare `kyc_documents` în profil

3. **Verificare EU ETS Registry**
   - Utilizatorul introduce număr cont registry și țară
   - Verificare automată (dacă API disponibil) sau manuală
   - Setare `eu_ets_registry_verified = true/false`
   - Dacă verificare eșuează, solicitare documente suplimentare

4. **Screening Sancțiuni și PEP**
   - La submit dosar, rulare automată screening:
     - Verificare liste sancțiuni (UN, EU, OFAC)
     - Verificare status PEP
     - Verificare beneficiari reali
   - Setare `sanctions_check_status` și `pep_status`
   - Dacă flag, escalare către reviewer manual

5. **Evaluare Suitability**
   - Utilizatorul completează formular suitability:
     - Obiective: compliance, hedging, investiție
     - Toleranță risc: conservator, moderat, agresiv
     - Experiență: începător, intermediar, avansat
     - Cunoștințe: test cu întrebări despre certificate CO2
   - Calculare scor suitability
   - Recomandare produse pe baza scorului
   - Salvare rezultate în `suitability_assessment`

6. **Evaluare Appropriateness**
   - Utilizatorul completează test appropriateness:
     - Test cunoștințe (minim 70% pentru aprobare)
     - Declarație experiență anterioară
   - Evaluare automată: aprobat/respins/necesită educație
   - Dacă respins, oferire resurse educaționale și posibilitate retestare
   - Salvare rezultate în `appropriateness_assessment`

7. **Review Manual (Compliance Team)**
   - Dosarul apare în dashboard admin pentru review
   - Reviewer verifică:
     - Completitudine documente
     - Validitate documente
     - Rezultate screening sancțiuni
     - Verificare EU ETS Registry
     - Rezultate evaluări suitability/appropriateness
   - Reviewer poate:
     - Aprobare dosar → `kyc_status = 'approved'`, activare cont
     - Respingere cu motiv → `kyc_status = 'rejected'`, notificare client
     - Solicitare actualizare → `kyc_status = 'needs_update'`, specificare documente necesare

8. **Aprobare și Activare**
   - La aprobare, setare `kyc_status = 'approved'`
   - Setare `kyc_approved_at = now()`
   - Activare cont pentru trading
   - Notificare email client
   - Redirecționare către dashboard

### Algoritm Evaluare Suitability

```pseudocode
FUNCȚIE assess_suitability(user_data, objectives, risk_tolerance, experience, knowledge_score):
  scor = 0
  
  // Evaluare obiective (0-30 puncte)
  DACĂ objectives == "compliance":
    scor += 30  // Produs perfect pentru compliance
  ALTFEL DACĂ objectives == "hedging":
    scor += 25
  ALTFEL DACĂ objectives == "investment":
    scor += 20
  
  // Evaluare toleranță risc (0-25 puncte)
  DACĂ risk_tolerance == "conservative":
    scor += 15  // Certificate CO2 pot fi volatile
  ALTFEL DACĂ risk_tolerance == "moderate":
    scor += 25
  ALTFEL DACĂ risk_tolerance == "aggressive":
    scor += 20
  
  // Evaluare experiență (0-25 puncte)
  DACĂ experience == "advanced":
    scor += 25
  ALTFEL DACĂ experience == "intermediate":
    scor += 20
  ALTFEL DACĂ experience == "beginner":
    scor += 10
  
  // Evaluare cunoștințe (0-20 puncte)
  scor += knowledge_score * 0.2
  
  // Determinare nivel suitability
  DACĂ scor >= 70:
    RETURN "suitable"  // Produs potrivit pentru client
  ALTFEL DACĂ scor >= 50:
    RETURN "suitable_with_warnings"  // Potrivit dar cu avertismente
  ALTFEL:
    RETURN "not_suitable"  // Produs nu este potrivit
```

### Algoritm Evaluare Appropriateness

```pseudocode
FUNCȚIE assess_appropriateness(user_data, knowledge_test, experience_declaration):
  // Test cunoștințe (minim 70% pentru aprobare)
  knowledge_score = (knowledge_test.correct_answers / knowledge_test.total_questions) * 100
  
  // Verificare experiență
  has_experience = experience_declaration.has_traded_carbon_certificates OR
                   experience_declaration.has_traded_similar_products OR
                   experience_declaration.has_financial_experience
  
  // Evaluare
  DACĂ knowledge_score >= 70 AND has_experience:
    RETURN {
      status: "approved",
      level: "full_access"  // Acces complet la trading
    }
  ALTFEL DACĂ knowledge_score >= 70 AND NOT has_experience:
    RETURN {
      status: "approved_with_education",
      level: "limited_access"  // Acces limitat, necesită educație
    }
  ALTFEL DACĂ knowledge_score >= 50:
    RETURN {
      status: "needs_education",
      level: "no_access"  // Necesită educație înainte de trading
    }
  ALTFEL:
    RETURN {
      status: "rejected",
      level: "no_access"  // Nu poate tranzacționa
    }
```

### Algoritm Screening Sancțiuni

```pseudocode
FUNCȚIE check_sanctions(name, date_of_birth, nationality):
  results = {
    sanctions_match: false,
    pep_match: false,
    risk_level: "low",
    matches: []
  }
  
  // Verificare liste sancțiuni (exemplu cu API extern)
  sanctions_data = call_sanctions_api(name, date_of_birth, nationality)
  
  DACĂ sanctions_data.has_matches:
    results.sanctions_match = true
    results.matches = sanctions_data.matches
    results.risk_level = "high"
    RETURN results
  
  // Verificare PEP status
  pep_data = check_pep_database(name, date_of_birth, nationality)
  
  DACĂ pep_data.is_pep:
    results.pep_match = true
    results.risk_level = "medium"  // PEP nu înseamnă automat risc ridicat
  
  RETURN results
```

## Faze de Implementare

### Faza 1: Data Layer și Backend Core (Fundament)

1. **Creare modele de date**
   - `backend/models/user.py` - Extindere User cu câmpuri KYC
   - `backend/models/kyc_document.py` - Model documente KYC
   - `backend/models/kyc_workflow.py` - Model workflow

2. **Creare servicii backend**
   - `backend/services/document_validator.py` - Validare documente
   - `backend/services/sanctions_checker.py` - Screening sancțiuni (mock inițial)
   - `backend/services/eu_ets_verifier.py` - Verificare registry (mock inițial)

3. **Creare API endpoints de bază**
   - `backend/api/kyc.py` - Endpoints pentru utilizatori
   - `backend/api/admin_kyc.py` - Endpoints pentru admini

### Faza 2A: Frontend Onboarding UI

1. **Creare componente onboarding**
   - `src/pages/Onboarding.tsx` - Pagină principală cu stepper
   - `src/components/onboarding/OnboardingStepper.tsx` - Componentă stepper
   - `src/components/onboarding/DocumentUpload.tsx` - Încărcare documente
   - `src/components/onboarding/EUETSRegistryForm.tsx` - Formular registry

2. **Integrare cu backend**
   - `src/services/kycService.ts` - Serviciu pentru API calls
   - `src/types/kyc.ts` - Tipuri TypeScript

3. **Rute și protecție**
   - Modificare `src/App.tsx` - Adăugare rute onboarding
   - Modificare `src/context/AuthContext.tsx` - Verificare KYC status

### Faza 2B: Evaluări Suitability și Appropriateness

1. **Componente evaluări**
   - `src/components/onboarding/SuitabilityAssessment.tsx`
   - `src/components/onboarding/AppropriatenessAssessment.tsx`

2. **Servicii backend evaluări**
   - `backend/services/suitability_assessor.py`
   - `backend/services/appropriateness_assessor.py`

3. **API endpoints evaluări**
   - Endpoints în `backend/api/kyc.py`

### Faza 3: Admin Dashboard și Review

1. **Dashboard admin**
   - `src/components/admin/KYCReview.tsx` - Dashboard review
   - Filtrare și căutare dosare
   - Acțiuni aprobare/respingere

2. **Workflow review**
   - Integrare cu backend pentru acțiuni admin
   - Notificări și istoric modificări

### Faza 4: Integrări Externe și Optimizări

1. **Integrări reale**
   - Integrare servicii screening sancțiuni (World-Check, Dow Jones, sau API-uri publice)
   - Integrare verificare EU ETS Registry (dacă API disponibil)

2. **Optimizări**
   - Caching rezultate screening
   - Background jobs pentru verificări automate
   - Email notifications pentru status updates

## Considerații Tehnice

### Securitate

- Stocare documente: criptare la rest, acces controlat
- Validare server-side pentru toate documentele
- Rate limiting pentru upload-uri
- Audit log pentru toate acțiunile KYC
- Păstrare documente conform GDPR (minim 5 ani după închidere cont)

### Performanță

- Upload asincron pentru documente mari
- Procesare background pentru screening sancțiuni
- Caching rezultate verificări
- Optimizare query-uri pentru dashboard admin

### UX/UI

- Stepper clar cu progres vizibil
- Validare în timp real
- Mesaje de eroare clare și acțiuni
- Suport multi-limbă (en, ro, zh)
- Responsive design pentru mobile
- Dark mode support

### Conformitate

- Respectare GDPR pentru date personale
- Respectare MiFID II pentru evaluări
- Respectare AMLD5 pentru KYC/AML
- Respectare cerințe EU ETS
- Păstrare înregistrări conform reglementărilor (minim 5-7 ani)

## Note de Implementare

- Documentul KYC/AML existent (`Nihao_Carbon_Certificates_KYC_AML_Compliance_Procedure.pdf`) trebuie să fie accesibil utilizatorilor în timpul onboarding
- Formularul de onboarding existent (`Nihao_Carbon_08_Client_Onboarding_Form.pdf`) poate fi folosit ca referință pentru câmpurile necesare
- Politica de Suitability/Appropriateness existentă (`Nihao_Carbon_13_Suitability_Appropriateness_Policy.pdf`) trebuie respectată în implementare
- Toate traducerile trebuie adăugate în cele trei limbi: engleză, română, chineză
